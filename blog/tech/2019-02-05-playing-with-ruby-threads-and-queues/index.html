<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/app.2f2933dc343b474e635f.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style data-href="/component---src-templates-blog-post-jsx.fd02eddb8ac8c65b8763.css">*{box-sizing:border-box;margin:0;padding:0}body,html{color:#2b2d42;font-size:18px;font-family:helvetica,sans-serif;line-height:1.4rem;font-weight:400}p{margin-bottom:1rem}body{padding:1.4rem .7rem;background-color:#f9fbfb}a{position:relative;color:#2b2d42;text-decoration:none;border-bottom:3px solid #d90429}a:before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#ef233c;transition:opacity .2s;opacity:0;z-index:-1}a:hover:before{opacity:.5}a:active:before{opacity:.7}.sdm-multiline-link{transition:background-color .2s}.sdm-multiline-link:before{content:none}.sdm-multiline-link:hover{background-color:rgba(239,35,60,.5)}.sdm-multiline-link:active{background-color:rgba(239,35,60,.7)}h1,h2{font-weight:900}h1{font-size:1.8rem;line-height:1.9rem;margin-bottom:2rem}h2{font-size:1.4rem;line-height:1.5rem;margin-top:1.4rem;margin-bottom:1rem}.sdm-accent{color:#ef233c}ol,ul{list-style:none;margin-bottom:1rem}.sdm-nav,footer{font-size:.75rem}.sdm-nav{margin-bottom:1rem}.sdm-nav:before{content:"\2190";margin-right:.2rem}@media screen and (min-width:701px){body{padding:1.4rem}}@media screen and (min-width:1025px){body,html{font-size:1.8vw}}.sdm-layout__block{margin-bottom:1.5rem}.sdm-blog__description{font-weight:400}.sdm-blog__content{font-size:1rem}.sdm-blog__content p{margin-bottom:1rem}.sdm-blog__content ul{list-style:square;margin-left:1rem;margin-bottom:1rem}.sdm-blog__content hr{border:none;text-align:center;padding:1rem 0}.sdm-blog__content hr:after{content:". . .";display:inline-block;position:relative;top:-.75rem;font-size:1.5rem;background:transparent}.sdm-blog__content pre{width:100vw;font-size:.8rem;margin-left:-.7rem;margin-right:-.7rem;padding:.7rem;margin-bottom:1rem}@media screen and (min-width:768px){.sdm-blog__content{font-size:1rem;width:750px}.sdm-blog__content pre{margin-left:-1.4rem;margin-right:-1.4rem;padding:.7rem 1.4rem}}</style><meta name="generator" content="Gatsby 2.0.53"/><title data-react-helmet="true">Dmitry Shvetsov, Fullstack Developer</title><meta data-react-helmet="true" name="description" content="Full stack web developer. I use with love Ruby, Node.js, JavaScript, SQL, NoSQL databases. Based in Vladivostok, Russia."/><meta data-react-helmet="true" name="author" content="Dmitry Shvetsov"/><meta data-react-helmet="true" name="og:title" content="Dmitry Shvetsov, Fullstack Developer"/><meta data-react-helmet="true" name="og:url" content="https://shvetsovdm.github.io/"/><meta data-react-helmet="true" name="og:description" content="Full stack web developer. I use with love Ruby, Node.js, JavaScript, SQL, NoSQL databases. Based in Vladivostok, Russia."/><meta data-react-helmet="true" name="og:image" content="https://www.gravatar.com/avatar/b8c8cd15abf09e505baec08c61a054a7"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#ef233c"/><link as="script" rel="preload" href="/0-6ca96f448628d89a4a58.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-jsx-99c20ef0a0022aed8aaa.js"/><link as="script" rel="preload" href="/app-984ef59361d1e3d776d6.js"/><link as="script" rel="preload" href="/webpack-runtime-0575035354b76fa0370a.js"/><link rel="preload" href="/static/d/866/path---blog-tech-2019-02-05-playing-with-ruby-threads-and-queues-0-ba-c47-xCAGfiy2zqNw9PkqMNXUAYCpo.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><nav class="sdm-nav"><a href="/blog">All articles</a></nav><div class="sdm-layout"><article class="sdm-layout__block"><h1>Playing with Ruby Threads and Queues</h1><h2 class="sdm-blog__description">Example of how to use queues to simplify multithereaded code in Ruby</h2><time dateTime="2017-01-30"></time><div class="sdm-blog__content"><p>Threads are the Ruby implementation for a concurrent programming. Threads are existing within an Operating System Process and have access to its memory. Actually, any code written in Ruby executes within a thread — main thread.</p>
<p>Threads are useful when code can be executed independently, especially when code spends time waiting for external events. This kind of situations happens when you dealing with Input and Output operations (I/O).</p>
<p>I have an example.</p>
<hr>
<p>Enter Worker.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
<span class="token keyword">end</span></code></pre></div>
<p>The whole purpose of the Worker is to do work. But what makes it useful is that it can do it in separate thread or threads.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span>num_threads<span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token variable">@num_threads</span> <span class="token operator">=</span> num_threads
    <span class="token variable">@threads</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">end</span>
  attr_reader <span class="token symbol">:num_threads</span><span class="token punctuation">,</span> <span class="token symbol">:threads</span>
  <span class="token keyword">private</span> <span class="token symbol">:threads</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">spawn_threads</span></span>
    num_threads<span class="token punctuation">.</span>times <span class="token keyword">do</span>
      threads <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token builtin">Thread</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">do</span>
        <span class="token comment"># there will be work that the worker performs</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>Since threads are useful for heavy I/O operations this worker is perfect to do HTTP requests, manipulate with files on disk, make DB requests.</p>
<p>“Hey, worker! Send this data to API and fetch some data from another API, after save some of it data in my database and don’t forget to log all you have done into a log file” — this is a perfect job for the worker.</p>
<hr>
<p>How we may pass work to the worker?</p>
<p>It is straightforward If you have to perform one single monotonous task every time.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
  <span class="token comment"># rest of the class omitted</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">spawn_threads</span></span>
    num_threads<span class="token punctuation">.</span>times <span class="token keyword">do</span>
      threads <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token builtin">Thread</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">do</span>
        <span class="token constant">HealthService</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">API</span><span class="token punctuation">.</span>ping <span class="token comment"># send a HTTP request</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>But what if you need to perform various kind of work depending on external circumstances.</p>
<hr>
<p>Queues to the rescue!</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span>num_threads<span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token variable">@num_threads</span> <span class="token operator">=</span> num_threads
    <span class="token variable">@threads</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token variable">@queue</span> <span class="token operator">=</span> <span class="token constant">Queue</span><span class="token punctuation">.</span><span class="token keyword">new</span>
  <span class="token class-name">end</span>
  <span class="token comment"># rest of the class omitted</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">enqueue</span></span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    queue<span class="token punctuation">.</span>push<span class="token punctuation">(</span><span class="token punctuation">[</span>action<span class="token punctuation">,</span> payload<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>With <code class="language-text">Worker#enqueue</code> method, it is now possible to pass work to the Worker. This can be done in many ways. For example, <code class="language-text">action</code> can be a Proc and <code class="language-text">payload</code> can be arguments for the Proc.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string">"net/http"</span>
<span class="token keyword">require</span> <span class="token string">"json"</span>
action <span class="token operator">=</span> proc <span class="token keyword">do</span> <span class="token operator">|</span>data<span class="token operator">|</span>
  <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">HTTP</span><span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    <span class="token constant">URI</span><span class="token punctuation">(</span><span class="token string">"https://api.some-ping-service.com"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    data<span class="token punctuation">.</span>to_json<span class="token punctuation">,</span>
    <span class="token string">"Content-Type"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"applicatoin/json"</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
<span class="token keyword">end</span>
worker_instance<span class="token punctuation">.</span>enqueue<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token punctuation">{</span> ok<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>What is great about Ruby implementation of Queues it that they are thread-safe by nature.</p>
<hr>
<p>To perform actions that enqueued into Worker and do not take all CPU resources we need to do arrange dequeued algorithm in a smart way.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">queue <span class="token operator">=</span> <span class="token constant">Queue</span><span class="token punctuation">.</span><span class="token keyword">new</span>

<span class="token class-name">loop</span> <span class="token keyword">do</span>
  puts <span class="token string">"we need dequeue actions and do some job"</span> <span class="token keyword">unless</span> queue<span class="token punctuation">.</span>empty<span class="token operator">?</span>
<span class="token keyword">end</span></code></pre></div>
<p>A loop like above will eat all you free CPU time.</p>
<p>Here is the output of <code class="language-text">top</code> command when the loop is running:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">top</span> -o cpu

PID    COMMAND      %CPU  TIME
56681  ruby         99.9  01:58.17</code></pre></div>
<p>The most common approach to solve this problem is to use sleep statement:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">queue <span class="token operator">=</span> <span class="token constant">Queue</span><span class="token punctuation">.</span><span class="token keyword">new</span>

<span class="token class-name">loop</span> <span class="token keyword">do</span>
  puts <span class="token string">"we need dequeue actions and do some job"</span> <span class="token keyword">unless</span> queue<span class="token punctuation">.</span>empty<span class="token operator">?</span>
  sleep <span class="token number">5</span>
<span class="token keyword">end</span></code></pre></div>
<p>And it will help, but this is not perfect.</p>
<p>Imagine how the Ruby interpreter has to spend the time to switch between the main thread and worker’s threads every sleep interval to just realize that we have nothing to do because the worker queue is empty. This issue will be multiplied by a number of threads and get worse when the sleep interval has to become smaller.</p>
<p><code class="language-text">sleep</code> is not an efficient way to catch something in the future.</p>
<hr>
<p>Again, Queues to the rescue!</p>
<p><code class="language-text">Queue#pop(non_block = false)</code> method, when <code class="language-text">non_block = false</code>, suspends current thread If the queue is empty until data is pushed onto the queue.</p>
<p>This means that worker’s thread that has nothing to do will wait for the next enqueued action. No <code class="language-text">sleep</code> required.</p>
<p>For convinienc Worker has domain specific methods that describes Worker state.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
  <span class="token comment"># rest of the class omitted</span>
  <span class="token keyword">private</span>
  attr_reader <span class="token symbol">:queue</span><span class="token punctuation">,</span> <span class="token symbol">:threads</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">actions</span></span><span class="token operator">?</span>
    <span class="token operator">!</span>queue<span class="token punctuation">.</span>empty<span class="token operator">?</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">running</span></span><span class="token operator">?</span>
    <span class="token operator">!</span>queue<span class="token punctuation">.</span>closed<span class="token operator">?</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">dequeue_action</span></span>
    queue<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">wait_for_action</span></span>
    queue<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>Most important here is <code class="language-text">#wait_for_action</code>. It suspends a thread of the Worker, as described above, when we have no actions in the queue.</p>
<p>Finally, it is time for the main part of the Worker class:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
  <span class="token comment"># rest of the class omitted</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">spawn_threads</span></span>
    num_threads<span class="token punctuation">.</span>times <span class="token keyword">do</span>
      threads <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token builtin">Thread</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">do</span>
        <span class="token keyword">while</span> running<span class="token operator">?</span> <span class="token operator">||</span> actions<span class="token operator">?</span>
          action_proc<span class="token punctuation">,</span> action_payload <span class="token operator">=</span> wait_for_action
          action_proc<span class="token punctuation">.</span>call<span class="token punctuation">(</span>action_payload<span class="token punctuation">)</span> <span class="token keyword">if</span> action_proc
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  <span class="token comment"># rest of the class omitted</span>
<span class="token keyword">end</span></code></pre></div>
<p>With <code class="language-text">#wait_for_action</code> that equals to <code class="language-text">queue.pop(false)</code> the worker starts to drain the queue exactly when the queue starts to fill up.</p>
<p>Perfecto!</p>
<hr>
<p>The last thing. The Worker needs to have a method to stop it.</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Worker</span>
  <span class="token comment"># rest of the class omitted</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">stop</span></span>
    queue<span class="token punctuation">.</span>close
    threads<span class="token punctuation">.</span><span class="token keyword">each</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:exit</span><span class="token punctuation">)</span>
    threads<span class="token punctuation">.</span>clear
    <span class="token keyword">true</span>
  <span class="token keyword">end</span>

  <span class="token comment"># rest of the class omitted</span>
<span class="token keyword">end</span></code></pre></div>
<p>Full example with some tweaks available in this <a href="https://gist.github.com/iamdidev/fd1ea8cfc96a908ca0e6fae298c0a7e3">gist</a>.</p>
<hr>
<p><em>Many thanks to Andrey Novikov and Vlad Dementyev for helping me grasp the subject of Ruby Threads and Queues.</em></p></div></article><footer class="sdm-layout__block sdm-layout__block--footer"><p>© Dmitry Shvetsov, 2016-2019</p></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-jsx","jsonName":"blog-tech-2019-02-05-playing-with-ruby-threads-and-queues-0ba","path":"/blog/tech/2019-02-05-playing-with-ruby-threads-and-queues/"};window.dataPath="866/path---blog-tech-2019-02-05-playing-with-ruby-threads-and-queues-0-ba-c47-xCAGfiy2zqNw9PkqMNXUAYCpo";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.2f2933dc343b474e635f.css","/app-984ef59361d1e3d776d6.js"],"component---src-templates-blog-post-jsx":["/component---src-templates-blog-post-jsx.fd02eddb8ac8c65b8763.css","/component---src-templates-blog-post-jsx-99c20ef0a0022aed8aaa.js"],"component---src-pages-404-js":["/component---src-pages-404-js.6067bc39943a4c5d3771.css","/component---src-pages-404-js-b8281387fba72835a9d2.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js.6067bc39943a4c5d3771.css","/component---src-pages-blog-js-fcb7851ffb8aad36dd4c.js"],"component---src-pages-index-js":["/component---src-pages-index-js.422f8ebedcb6b35dcf32.css","/component---src-pages-index-js-a134206f2e0db3327611.js"],"component---src-pages-travels-2019-03-beijing-js":["/component---src-pages-travels-2019-03-beijing-js.6067bc39943a4c5d3771.css","/component---src-pages-travels-2019-03-beijing-js-9fcc786f1513c544fca3.js"]};/*]]>*/</script><script src="/webpack-runtime-0575035354b76fa0370a.js" async=""></script><script src="/app-984ef59361d1e3d776d6.js" async=""></script><script src="/component---src-templates-blog-post-jsx-99c20ef0a0022aed8aaa.js" async=""></script><script src="/0-6ca96f448628d89a4a58.js" async=""></script></body></html>