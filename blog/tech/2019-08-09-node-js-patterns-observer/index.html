<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/app.2f2933dc343b474e635f.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style data-href="/component---src-templates-blog-post-jsx.0828aaf984a3bc83c03b.css">*{box-sizing:border-box;margin:0;padding:0}body,html{color:#2b2d42;font-size:18px;font-family:helvetica,sans-serif;line-height:1.4rem;font-weight:400}p{margin-bottom:1rem}body{padding:1.4rem .7rem;background-color:#f9fbfb}a{position:relative;color:#2b2d42;text-decoration:none;border-bottom:3px solid #d90429}a:before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:#ef233c;transition:opacity .2s;opacity:0;z-index:-1}a:hover:before{opacity:.5}a:active:before{opacity:.7}.sdm-multiline-link{transition:background-color .2s}.sdm-multiline-link:before{content:none}.sdm-multiline-link:hover{background-color:rgba(239,35,60,.5)}.sdm-multiline-link:active{background-color:rgba(239,35,60,.7)}h1,h2{font-weight:900}h1{font-size:1.8rem;line-height:1.9rem;margin-bottom:2rem}h2{font-size:1.4rem;line-height:1.5rem;margin-top:1.4rem;margin-bottom:1rem}.sdm-accent{color:#ef233c}ol,ul{list-style:none;margin-bottom:1rem}.sdm-nav,footer{font-size:.75rem}.sdm-nav{margin-bottom:1rem}.sdm-nav:before{content:"\2190";margin-right:.2rem}@media screen and (min-width:701px){body{padding:1.4rem}}@media screen and (min-width:1025px){body,html{font-size:1.8vw}}.sdm-layout__block{margin-bottom:1.5rem}.sdm-blog__description{font-weight:400}.sdm-blog__content{font-size:1rem}.sdm-blog__content a{border:none;text-decoration:underline;color:#d90429}.sdm-blog__content a:hover{opacity:.8}.sdm-blog__content a:before{background-color:transparent}.sdm-blog__content p{margin-bottom:1rem}.sdm-blog__content ol,.sdm-blog__content ul{margin-left:1rem;margin-bottom:1rem}.sdm-blog__content ol{list-style-type:decimal}.sdm-blog__content ul{list-style:square}.sdm-blog__content hr{border:none;text-align:center;padding:1rem 0}.sdm-blog__content hr:after{content:". . .";display:inline-block;position:relative;top:-.75rem;font-size:1.5rem;background:transparent}.sdm-blog__content blockquote{font-style:italic;border-left:.2rem solid #ef233c;padding-left:1rem}.sdm-blog__content pre{width:100vw;font-size:.8rem;margin-left:-.7rem;margin-right:-.7rem;padding:.7rem;margin-bottom:1rem}@media screen and (min-width:768px){.sdm-blog__content{font-size:1rem;width:750px}.sdm-blog__content pre{margin-left:-1.4rem;margin-right:-1.4rem;padding:.7rem 1.4rem}}</style><meta name="generator" content="Gatsby 2.0.53"/><title data-react-helmet="true">Dmitry Shvetsov, Fullstack Developer</title><meta data-react-helmet="true" name="description" content="Full stack web developer. I use with love Ruby, Node.js, JavaScript, SQL, NoSQL databases. Based in Vladivostok, Russia."/><meta data-react-helmet="true" name="author" content="Dmitry Shvetsov"/><meta data-react-helmet="true" name="og:title" content="Dmitry Shvetsov, Fullstack Developer"/><meta data-react-helmet="true" name="og:url" content="https://shvetsovdm.github.io/"/><meta data-react-helmet="true" name="og:description" content="Full stack web developer. I use with love Ruby, Node.js, JavaScript, SQL, NoSQL databases. Based in Vladivostok, Russia."/><meta data-react-helmet="true" name="og:image" content="https://www.gravatar.com/avatar/b8c8cd15abf09e505baec08c61a054a7"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#ef233c"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/0-db19d7fcec3bd86415fa.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-jsx-4685366c953814782e7a.js"/><link as="script" rel="preload" href="/app-7adc6da1223f4911c098.js"/><link as="script" rel="preload" href="/webpack-runtime-f03243f82eb10b23ffa0.js"/><link rel="preload" href="/static/d/622/path---blog-tech-2019-08-09-node-js-patterns-observer-327-b5b-c3lsezcKLbCIVloBKkmap4MPDw.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><nav class="sdm-nav"><a href="/blog">All articles</a></nav><div class="sdm-layout"><article class="sdm-layout__block"><h1>The Observer pattern</h1><h2 class="sdm-blog__description"></h2><div class="sdm-blog__content"><h2>The Observer pattern</h2>
<p>TODO explanation
TODO example of combining callback with EventEmitter for exposing single function with clean API covered main use case and returning instance of EventEmitter for extra features.</p>
<p>TODO: need title
Using callback-style programming can lead to callback hell or pyramid of doom. Some patterns to avoid this.
Sequential callback pattern
function storeData(data, callback) {
asyncStore(data, (err, storeResult) => {
if (err) return callback(err);
callback(null, storeResult);
});
}
function processRawData(rawData, callback) {
asyncProcessing(result, (err, processedData) => {
if (err) return callback(err);
storeData(processedData, callback);
});
}
function startProcessing(args, callback) {
asyncStart(args, (err, rawData) => {
if (err) return callback(err);
processRawData(rawData, callback);
});
}
Sometimes final function can be written in a terse manner, if arguments for async function callback are equal err + result of the async function.
function storeData(data, callback) {
asyncStore(data, callback);
}
Iteration callback pattern
function iterateAll() {
const iterate = (index) => {
if (index === collection.length) {
return callback();
}
const item = collection[index];
processItem(item, (err) => {
if (err) return callback(err);
iterate(index + 1);
});
};
iterate(0);
}
The pattern can be generalized as:
function iterateOver(collection, fn, callback) {
const iterate = (index) => {
if (index === collection.length) {
return callback();
}
const item = collection[index];
fn(item, (err) => {
if (err) return callback(err);
iterate(index + 1);
});
};
iterate(0);
}
iterateWithCallback(
collection,
processItem,
() => console.log('done')
);
Concurrent callback pattern
When an order of the execution of the callback over the collection doesn't matter concurrent pattern can drastically improve the performance of the asynchronous processing of the collection.
function processConcurrently(collection, callback) {
let completed = 0;
let noErrors = false;</p>
<p>  const processCallback = (err) => {
if (err) {
noErrors = false;
return callback(err);
}
completed += 1;
if (completed === collection.length &#x26;&#x26; !hasError) {
callback();
}
};
collection.forEach(item => processItem(item, processCallback);
}
Be aware of race conditions because they can be possible in the concurrent pattern.
TODO: Possible solution for a race condition in the concurrent pattern.
Limited concurrent callback patter
Consider a recursive example of the concurrent pattern:
TODO: recursive concurrent pattern example
Queues can help limit concurent execution
TODO: recursive concurrent pattern example with a queue
Examples can be looked up in async library.
Generators sequential pattern
TODO
Generators concurent pattern
TODO
Limited concurrent pattern with queues
TODO</p></div></article><footer class="sdm-layout__block sdm-layout__block--footer"><p>© Dmitry Shvetsov, 2016-2019</p></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-47078794-2', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-jsx","jsonName":"blog-tech-2019-08-09-node-js-patterns-observer-327","path":"/blog/tech/2019-08-09-node-js-patterns-observer/"};window.dataPath="622/path---blog-tech-2019-08-09-node-js-patterns-observer-327-b5b-c3lsezcKLbCIVloBKkmap4MPDw";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.2f2933dc343b474e635f.css","/app-7adc6da1223f4911c098.js"],"component---src-templates-blog-post-jsx":["/component---src-templates-blog-post-jsx.0828aaf984a3bc83c03b.css","/component---src-templates-blog-post-jsx-4685366c953814782e7a.js"],"component---src-pages-404-js":["/component---src-pages-404-js.6067bc39943a4c5d3771.css","/component---src-pages-404-js-3b3f9a77386270d1d123.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js.6067bc39943a4c5d3771.css","/component---src-pages-blog-js-1c82cca2b9db1be17f1d.js"],"component---src-pages-index-js":["/component---src-pages-index-js.422f8ebedcb6b35dcf32.css","/component---src-pages-index-js-98b6096360c72207371d.js"],"component---src-pages-travels-2019-03-beijing-js":["/component---src-pages-travels-2019-03-beijing-js.6067bc39943a4c5d3771.css","/component---src-pages-travels-2019-03-beijing-js-25b68bf7e2fecd80b05f.js"]};/*]]>*/</script><script src="/webpack-runtime-f03243f82eb10b23ffa0.js" async=""></script><script src="/app-7adc6da1223f4911c098.js" async=""></script><script src="/component---src-templates-blog-post-jsx-4685366c953814782e7a.js" async=""></script><script src="/0-db19d7fcec3bd86415fa.js" async=""></script></body></html>